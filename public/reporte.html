<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Instalaci√≥n</title>
    <link rel="stylesheet" href="minimal-style.css">
    <style>
        .whatsapp-link-container { margin-top: 1rem; text-align: center; }
        .whatsapp-link-container a { display: inline-block; background-color: #25D366; color: white; padding: 0.8rem 1.5rem; border-radius: 5px; text-decoration: none; font-weight: bold; transition: background-color 0.3s ease; }
        .whatsapp-link-container a:hover { background-color: #1DA851; }
        input[readonly] { background-color: #f3f4f6; cursor: not-allowed; }

        /* --- NUEVOS ESTILOS PARA LA VENTANA DE B√öSQUEDA (MODAL) --- */
        .input-with-icon { display: flex; align-items: center; gap: 0.5rem; }
        .input-with-icon input { flex-grow: 1; }
        .search-icon { font-size: 1.5rem; cursor: pointer; user-select: none; }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px; right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .search-results-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-top: 1rem;
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: #f0f0f0;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        #modal-search-input {
            width: 100%;
            padding: 0.75rem;
            box-sizing: border-box;
        }

    </style>
</head>
<body>
    <div class="container" id="password-container">
        <div class="form-header"><h1>Acceso para Instaladores</h1><p>Ingrese la clave para acceder.</p></div>
        <form id="password-form">
            <div class="form-group"><label for="password">Clave de Acceso</label><input type="password" id="password" required></div>
            <button type="submit" class="btn-primary" style="width: 100%;">Ingresar</button>
        </form>
    </div>

    <div class="container" id="form-container" style="display:none;">
        <div class="form-header"><h1>Reporte de Instalaci√≥n</h1><p>Llenar los datos t√©cnicos de la instalaci√≥n.</p></div>
        <form id="reporteForm">
            <div class="form-group"><label for="fecha_reporte">Fecha</label><input type="text" id="fecha_reporte" name="fecha_reporte" readonly required></div>
            <div class="form-group"><label for="hora_reporte">Hora</label><input type="text" id="hora_reporte" name="hora_reporte" readonly required></div>
            
            <div class="form-group">
                <label for="id_solicitud">ID de Solicitud</label>
                <div class="input-with-icon">
                    <input type="text" id="id_solicitud" name="id_solicitud" required>
                    <span id="open-search-modal" class="search-icon">üîç</span>
                </div>
            </div>

            <div class="form-group"><label for="nombre_cliente">Cliente</label><input type="text" id="nombre_cliente" name="nombre_cliente" readonly required></div>
            <div class="form-group"><label for="equipo">Equipo</label>
                <select id="equipo" name="equipo" required>
                    <option value="" disabled selected>Seleccione un equipo</option>
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option><option value="K">K</option><option value="L">L</option><option value="M">M</option><option value="N">N</option><option value="O">O</option><option value="P">P</option><option value="Q">Q</option><option value="R">R</option><option value="S">S</option><option value="T">T</option><option value="U">U</option><option value="V">V</option><option value="W">W</option><option value="X">X</option><option value="Y">Y</option><option value="Z">Z</option>
                </select>
            </div>
             <div class="form-group"><label for="plan_contratado">Plan Contratado</label>
                <select id="plan_contratado" name="plan_contratado" required>
                    <option value="" disabled selected>Seleccione un plan</option>
                    <option value="400 MB Residencial">400 MB Residencial</option><option value="600 MB Residencial">600 MB Residencial</option><option value="800 MB Residencial">800 MB Residencial</option><option value="400 MB Corporativo">400 MB Corporativo</option><option value="600 MB Corporativo">600 MB Corporativo</option><option value="800 MB Corporativo">800 MB Corporativo</option><option value="1 Giga Corporativo">1 Giga Corporativo</option>
                </select>
            </div>
            <div class="form-group"><label for="tecnico_1">T√©cnico 1</label><input type="text" id="tecnico_1" name="tecnico_1" required></div>
            <div class="form-group"><label for="tecnico_2">T√©cnico 2</label><input type="text" id="tecnico_2" name="tecnico_2"></div>
            
            <hr>
            <div class="form-group"><label for="metodo_pago">M√©todo de Pago</label>
                <select id="metodo_pago" name="metodo_pago" required>
                    <option value="" disabled selected>Seleccione un m√©todo</option>
                    <option value="Pago Movil">Pago Movil</option><option value="Efectivo ($)">Efectivo ($)</option><option value="Efectivo (Bs)">Efectivo (Bs)</option><option value="Efectivo (‚Ç¨)">Efectivo (‚Ç¨)</option><option value="Zelle">Zelle</option><option value="Paypal">Paypal</option>
                </select>
            </div>
            <div class="form-group"><label for="pw_asignado">PW Asignado</label><input type="text" id="pw_asignado" name="pw_asignado" placeholder="Ej: PW1 o PW20500"></div>
            <div class="form-group"><label for="mac">MAC</label><input type="text" id="mac" name="mac"></div>
            <div class="form-group"><label for="router">Router</label><input type="text" id="router" name="router"></div>
            <div class="form-group"><label for="precinto">Precinto</label><input type="text" id="precinto" name="precinto" pattern="[0-9]{8}" title="Debe contener exactamente 8 d√≠gitos num√©ricos." maxlength="8"></div>
            <div class="form-group"><label for="onu_pon">ONU PON</label><input type="text" id="onu_pon" name="onu_pon"></div>
            <div class="form-group"><label for="velocidad_descarga_mbps">V. Descarga (Mbps)</label><input type="number" id="velocidad_descarga_mbps" name="velocidad_descarga_mbps"></div>
            <div class="form-group"><label for="velocidad_subida_mbps">V. Subida (Mbps)</label><input type="number" id="velocidad_subida_mbps" name="velocidad_subida_mbps"></div>
            <div class="form-group"><label for="potencia_nap">Potencia NAP</label><input type="number" step="any" id="potencia_nap" name="potencia_nap" min="-30" max="-10"></div>
            <div class="form-group"><label for="potencia_cliente">Potencia Cliente</label><input type="number" step="any" id="potencia_cliente" name="potencia_cliente"></div>
            <div class="form-group"><label for="metraje_utilizado_m">Metraje utilizado (m)</label><input type="number" id="metraje_utilizado_m" name="metraje_utilizado_m"></div>
            <div class="form-group"><label for="metraje_desechado_m">Metraje desechado (m)</label><input type="number" id="metraje_desechado_m" name="metraje_desechado_m"></div>
            <div class="form-group"><label for="tensores_utilizados">Tensores Utilizados</label><input type="number" id="tensores_utilizados" name="tensores_utilizados"></div>
            <div class="form-group"><label for="estado_instalacion">Estado de la Instalaci√≥n</label>
                <select id="estado_instalacion" name="estado_instalacion" required>
                    <option value="Exitosa">Exitosa</option><option value="En punta">En punta</option>
                </select>
            </div>
            
            <div id="reporteForm-status-message" class="status-message"></div>
            <div id="reporteForm-whatsapp-container" class="whatsapp-link-container" style="display: none;"><p>El reporte ha sido guardado. Ahora, haz clic en el bot√≥n para enviar el reporte a WhatsApp:</p><a id="reporteForm-whatsapp-link" href="#" target="_blank">Enviar Reporte por WhatsApp</a></div>
            <button type="submit" class="btn-primary" id="reporteForm-btn">Guardar Reporte</button>
        </form>
    </div>

    <div id="search-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Buscar Solicitud Pendiente</h2>
            <input type="text" id="modal-search-input" placeholder="Buscar por ID, nombre o sector...">
            <div id="search-results-list" class="search-results-list">
                </div>
        </div>
    </div>


    <script>
        // La l√≥gica de WhatsApp no cambia
        function setupWhatsAppIntegration(formId, apiEndpoint, messageBuilder, options = {}) {
            const form = document.getElementById(formId);
            if (!form) return;
            const submitButton = form.querySelector('button[type="submit"]');
            const statusMessage = form.querySelector(`#${formId}-status-message`);
            const whatsappLinkContainer = form.querySelector(`#${formId}-whatsapp-container`);
            const whatsappLink = form.querySelector(`#${formId}-whatsapp-link`);
            if (!submitButton || !statusMessage || !whatsappLinkContainer || !whatsappLink) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = 'Guardando...';
                statusMessage.textContent = '';
                whatsappLinkContainer.style.display = 'none';
                const formData = new FormData(form);
                const dataObject = Object.fromEntries(formData.entries());
                dataObject.mac = dataObject.mac || 'N/A';
                dataObject.router = dataObject.router || 'N/A';
                try {
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataObject)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Error desconocido' }));
                        throw new Error(errorData.message || 'Error del servidor al guardar');
                    }
                    statusMessage.className = 'status-message success';
                    statusMessage.textContent = '¬°Informaci√≥n guardada con √©xito!';
                    submitButton.style.display = 'none';
                    const whatsappMessage = messageBuilder(dataObject);
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`;
                    whatsappLink.href = whatsappUrl;
                    whatsappLinkContainer.style.display = 'block';
                    if (options.resetFormOnSuccess) {
                        form.reset(); 
                        if (options.postResetCallback) options.postResetCallback();
                    }
                } catch (error) {
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = `Error: ${error.message}`;
                } finally {
                    if (statusMessage.className.includes('error')) {
                         submitButton.disabled = false;
                         submitButton.textContent = options.originalSubmitText || 'Guardar';
                         submitButton.style.display = 'block';
                    }
                }
            });
        }
        // La construcci√≥n del mensaje de WhatsApp no cambia
        const buildReporteMessage = (data) => {
            return `*Reporte De instalaci√≥n:*\n\n` +
                `*Fecha:* ${data.fecha_reporte || 'N/A'}\n*Hora:* ${data.hora_reporte || 'N/A'}\n*Equipo:* ${data.equipo || 'N/A'}\n` +
                `*ID Solicitud:* ${data.id_solicitud || 'N/A'}\n*Cliente:* ${data.nombre_cliente || 'N/A'}\n*PW Asignado:* ${data.pw_asignado || 'N/A'}\n` +
                `*MAC:* ${data.mac}\n*Router:* ${data.router}\n*Precinto:* ${data.precinto || 'N/A'}\n*ONU PON:* ${data.onu_pon || 'N/A'}\n` +
                `*Instalaci√≥n:* ${data.estado_instalacion || 'N/A'}\n*M√©todo de Pago:* ${data.metodo_pago || 'N/A'}\n*PLAN:* ${data.plan_contratado || 'N/A'}\n` +
                `*V. descarga:* ${data.velocidad_descarga_mbps || 'N/A'}\n*V. Subida:* ${data.velocidad_subida_mbps || 'N/A'}\n*Potencia NAP:* ${data.potencia_nap || 'N/A'}\n` +
                `*Potencia Cliente:* ${data.potencia_cliente || 'N/A'}\n*Metraje utilizado:* ${data.metraje_utilizado_m || 'N/A'}\n` +
                `*Metraje desechado:* ${data.metraje_desechado_m || 'N/A'}\n*Tensores utilizados:* ${data.tensores_utilizados || 'N/A'}\n` +
                `*T√©cnico 1:* ${data.tecnico_1 || 'N/A'}\n*T√©cnico 2:* ${data.tecnico_2 || 'N/A'}`;
        };

        // --- NUEVA L√ìGICA COMPLETA PARA EL FORMULARIO Y LA B√öSQUEDA ---
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a elementos del DOM
            const passwordForm = document.getElementById('password-form');
            const passwordContainer = document.getElementById('password-container');
            const formContainer = document.getElementById('form-container');
            
            // Elementos del Modal
            const modal = document.getElementById('search-modal');
            const openModalBtn = document.getElementById('open-search-modal');
            const closeModalBtn = document.querySelector('.close-button');
            const searchInput = document.getElementById('modal-search-input');
            const resultsList = document.getElementById('search-results-list');
            const idSolicitudInput = document.getElementById('id_solicitud');
            
            let solicitudesPendientes = []; // Almac√©n de datos local

            // --- FUNCIONES ---

            // Rellena los campos del formulario principal
            function fillFormFields(solicitud) {
                if (!solicitud) return;
                idSolicitudInput.value = solicitud.id;
                document.getElementById('nombre_cliente').value = solicitud.nombre_cliente || '';
                document.getElementById('plan_contratado').value = solicitud.plan_contratado || '';
                document.getElementById('equipo').value = solicitud.equipo || '';
                document.getElementById('tecnico_1').value = solicitud.tecnico_1 || '';
                document.getElementById('tecnico_2').value = solicitud.tecnico_2 || '';
            }
            
            // Muestra los resultados en la lista del modal
            function renderSearchResults(list) {
                resultsList.innerHTML = ''; // Limpiar lista anterior
                if (list.length === 0) {
                    resultsList.innerHTML = '<div class="search-result-item">No se encontraron resultados.</div>';
                    return;
                }
                list.forEach(solicitud => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = `ID: ${solicitud.id} - ${solicitud.nombre_cliente} (${solicitud.sector})`;
                    item.dataset.id = solicitud.id; // Guardar el ID en el elemento
                    resultsList.appendChild(item);
                });
            }

            // Carga las solicitudes desde el servidor
            async function cargarSolicitudes() {
                try {
                    const response = await fetch('/api/solicitudes/pendientes');
                    if (!response.ok) throw new Error('No se pudo conectar.');
                    solicitudesPendientes = await response.json();
                    renderSearchResults(solicitudesPendientes); // Mostrar la lista completa al inicio
                } catch (error) {
                    resultsList.innerHTML = `<div class="search-result-item">Error al cargar: ${error.message}</div>`;
                }
            }
            
            // --- EVENT LISTENERS ---

            // Abrir y cerrar el modal
            openModalBtn.addEventListener('click', () => modal.style.display = 'block');
            closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', (e) => {
                if (e.target == modal) modal.style.display = 'none';
            });

            // Filtrar la lista al escribir en el campo de b√∫squeda del modal
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredList = solicitudesPendientes.filter(s => 
                    s.id.toString().includes(searchTerm) ||
                    s.nombre_cliente.toLowerCase().includes(searchTerm) ||
                    s.sector.toLowerCase().includes(searchTerm)
                );
                renderSearchResults(filteredList);
            });
            
            // Seleccionar un item de la lista de resultados
            resultsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('search-result-item') && e.target.dataset.id) {
                    const selectedId = parseInt(e.target.dataset.id);
                    const solicitudSeleccionada = solicitudesPendientes.find(s => s.id === selectedId);
                    fillFormFields(solicitudSeleccionada);
                    modal.style.display = 'none'; // Cerrar modal al seleccionar
                }
            });

            // Validar ID si se escribe manualmente
            idSolicitudInput.addEventListener('blur', () => {
                const manualId = parseInt(idSolicitudInput.value);
                if (manualId) {
                    const solicitudEncontrada = solicitudesPendientes.find(s => s.id === manualId);
                    if(solicitudEncontrada) {
                       fillFormFields(solicitudEncontrada);
                    }
                }
            });

            // L√≥gica de la contrase√±a (inicia todo)
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (e.target.querySelector('input').value === '0000') {
                    passwordContainer.style.display = 'none';
                    formContainer.style.display = 'block';

                    const ahora = new Date();
                    const offset = ahora.getTimezoneOffset() * 60000;
                    const ahoraLocal = new Date(ahora.getTime() - offset);
                    document.getElementById('fecha_reporte').value = ahoraLocal.toISOString().split('T')[0];
                    document.getElementById('hora_reporte').value = ahoraLocal.toTimeString().split(' ')[0].substring(0, 5);
                    
                    cargarSolicitudes(); // Cargar los datos para la b√∫squeda

                    setupWhatsAppIntegration('reporteForm', '/api/reportes/instalacion', buildReporteMessage, {
                        resetFormOnSuccess: true,
                        postResetCallback: () => {
                            cargarSolicitudes(); // Recargar datos despu√©s de enviar
                            const ahora = new Date();
                            const offset = ahora.getTimezoneOffset() * 60000;
                            const ahoraLocal = new Date(ahora.getTime() - offset);
                            document.getElementById('fecha_reporte').value = ahoraLocal.toISOString().split('T')[0];
                            document.getElementById('hora_reporte').value = ahoraLocal.toTimeString().split(' ')[0].substring(0, 5);
                        },
                        originalSubmitText: 'Guardar Reporte'
                    });
                } else {
                    alert('Clave incorrecta.');
                }
            });

            document.getElementById('precinto').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        });
    </script>
</body>
</html>
