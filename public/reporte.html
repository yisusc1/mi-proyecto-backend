<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Instalaci√≥n</title>
    <link rel="stylesheet" href="minimal-style.css">
    <style>
        .whatsapp-link-container { margin-top: 1rem; text-align: center; }
        .whatsapp-link-container a { display: inline-block; background-color: #25D366; color: white; padding: 0.8rem 1.5rem; border-radius: 5px; text-decoration: none; font-weight: bold; transition: background-color: 0.3s ease; }
        .whatsapp-link-container a:hover { background-color: #1DA851; }
        input[readonly] { background-color: #f3f4f6; cursor: not-allowed; }
        .input-with-icon { display: flex; align-items: center; gap: 0.5rem; }
        .input-with-icon input { flex-grow: 1; }
        .search-icon { font-size: 1.5rem; cursor: pointer; user-select: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .search-results-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; margin-top: 1rem; }
        .search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .search-result-item:hover { background-color: #f0f0f0; }
        .search-result-item:last-child { border-bottom: none; }
        #modal-search-input { width: 100%; padding: 0.75rem; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="container" id="password-container">
        <div class="form-header"><h1>Acceso para Instaladores</h1><p>Ingrese la clave para acceder.</p></div>
        <form id="password-form">
            <div class="form-group"><label for="password">Clave de Acceso</label><input type="password" id="password" required></div>
            <button type="submit" class="btn-primary" style="width: 100%;">Ingresar</button>
        </form>
    </div>

    <div class="container" id="form-container" style="display:none;">
        <div class="form-header"><h1>Reporte de Instalaci√≥n</h1><p>Llenar los datos t√©cnicos de la instalaci√≥n.</p></div>
        <form id="reporteForm">
            <div class="form-group"><label for="fecha_reporte">Fecha</label><input type="text" id="fecha_reporte" name="fecha_reporte" readonly required></div>
            <div class="form-group"><label for="hora_reporte">Hora</label><input type="text" id="hora_reporte" name="hora_reporte" readonly required></div>
            
            <div class="form-group">
                <label for="id_solicitud">ID de Solicitud</label>
                <div class="input-with-icon">
                    <input type="text" id="id_solicitud" name="id_solicitud" required>
                    <span id="open-search-modal" class="search-icon" title="Buscar solicitud asignada">üîç</span>
                    <span id="open-fast-entry-modal" class="search-icon" title="Registro r√°pido de instalaci√≥n">‚ö°</span>
                </div>
            </div>

            <div class="form-group"><label for="nombre_cliente">Cliente</label><input type="text" id="nombre_cliente" name="nombre_cliente" required></div>
            
            <div class="form-group"><label for="equipo">Equipo</label><select id="equipo" name="equipo" required><option value="" disabled selected>Seleccione un equipo</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option><option value="H">H</option><option value="I">I</option><option value="J">J</option><option value="K">K</option><option value="L">L</option><option value="M">M</option><option value="N">N</option><option value="O">O</option><option value="P">P</option><option value="Q">Q</option><option value="R">R</option><option value="S">S</option><option value="T">T</option><option value="U">U</option><option value="V">V</option><option value="W">W</option><option value="X">X</option><option value="Y">Y</option><option value="Z">Z</option></select></div>
            <div class="form-group"><label for="plan_contratado">Plan Contratado</label><select id="plan_contratado" name="plan_contratado" required><option value="" disabled selected>Seleccione un plan</option><option value="400 MB Residencial">400 MB Residencial</option><option value="600 MB Residencial">600 MB Residencial</option><option value="800 MB Residencial">800 MB Residencial</option><option value="400 MB Corporativo">400 MB Corporativo</option><option value="600 MB Corporativo">600 MB Corporativo</option><option value="800 MB Corporativo">800 MB Corporativo</option><option value="1 Giga Corporativo">1 Giga Corporativo</option></select></div>
            <div class="form-group"><label for="tecnico_1">T√©cnico 1</label><input type="text" id="tecnico_1" name="tecnico_1" required></div>
            <div class="form-group"><label for="tecnico_2">T√©cnico 2</label><input type="text" id="tecnico_2" name="tecnico_2"></div>
            <hr>
            <div class="form-group"><label for="metodo_pago">M√©todo de Pago</label><select id="metodo_pago" name="metodo_pago" required><option value="" disabled selected>Seleccione un m√©todo</option><option value="Pago Movil">Pago Movil</option><option value="Efectivo ($)">Efectivo ($)</option><option value="Efectivo (Bs)">Efectivo (Bs)</option><option value="Efectivo (‚Ç¨)">Efectivo (‚Ç¨)</option><option value="Zelle">Zelle</option><option value="Paypal">Paypal</option></select></div>
            <div class="form-group"><label for="pw_asignado">PW Asignado</label><input type="text" id="pw_asignado" name="pw_asignado" placeholder="Ej: PW1 o PW20500"></div>
            <div class="form-group"><label for="mac">MAC</label><input type="text" id="mac" name="mac"></div>
            <div class="form-group"><label for="router">Router</label><input type="text" id="router" name="router"></div>
            <div class="form-group"><label for="precinto">Precinto</label><input type="text" id="precinto" name="precinto" pattern="[0-9]{8}" title="Debe contener exactamente 8 d√≠gitos num√©ricos." maxlength="8"></div>
            <div class="form-group"><label for="onu_pon">ONU PON</label><input type="text" id="onu_pon" name="onu_pon"></div>
            <div class="form-group"><label for="velocidad_descarga_mbps">V. Descarga (Mbps)</label><input type="number" id="velocidad_descarga_mbps" name="velocidad_descarga_mbps"></div>
            <div class="form-group"><label for="velocidad_subida_mbps">V. Subida (Mbps)</label><input type="number" id="velocidad_subida_mbps" name="velocidad_subida_mbps"></div>
            <div class="form-group"><label for="potencia_nap">Potencia NAP</label><input type="number" step="any" id="potencia_nap" name="potencia_nap" min="-30" max="-10"></div>
            <div class="form-group"><label for="potencia_cliente">Potencia Cliente</label><input type="number" step="any" id="potencia_cliente" name="potencia_cliente"></div>
            <div class="form-group"><label for="metraje_utilizado_m">Metraje utilizado (m)</label><input type="number" id="metraje_utilizado_m" name="metraje_utilizado_m"></div>
            <div class="form-group"><label for="metraje_desechado_m">Metraje desechado (m)</label><input type="number" id="metraje_desechado_m" name="metraje_desechado_m"></div>
            <div class="form-group"><label for="tensores_utilizados">Tensores Utilizados</label><input type="number" id="tensores_utilizados" name="tensores_utilizados"></div>
            <div class="form-group"><label for="estado_instalacion">Estado de la Instalaci√≥n</label><select id="estado_instalacion" name="estado_instalacion" required><option value="Exitosa">Exitosa</option><option value="En punta">En punta</option></select></div>
            
            <div id="reporteForm-status-message" class="status-message"></div>
            <div id="reporteForm-whatsapp-container" class="whatsapp-link-container" style="display: none;"><p>El reporte ha sido guardado. Ahora, haz clic en el bot√≥n para enviar el reporte a WhatsApp:</p><a id="reporteForm-whatsapp-link" href="#" target="_blank">Enviar Reporte por WhatsApp</a></div>
            <button type="submit" class="btn-primary" id="reporteForm-btn">Guardar Reporte</button>
        </form>
    </div>

    <div id="search-modal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Buscar Solicitud Pendiente</h2><input type="text" id="modal-search-input" placeholder="Buscar por ID, nombre o sector..."><div id="search-results-list" class="search-results-list"></div></div></div>
    <div id="fast-entry-modal" class="modal"><div class="modal-content"><span id="close-fast-entry-modal" class="close-button">&times;</span><h2>Clave de Registro R√°pido</h2><p>Ingresa la clave de 4 d√≠gitos para registrar una instalaci√≥n encontrada.</p><input type="password" id="fast-entry-password" placeholder="Clave de 4 d√≠gitos" maxlength="4" style="text-align:center; font-size: 1.5rem; letter-spacing: 0.5rem;"><button id="validate-fast-entry-key" class="btn-primary" style="width: 100%; margin-top: 1rem;">Validar Clave</button><div id="fast-entry-message" class="status-message" style="margin-top: 1rem;"></div></div></div>

    <script>
        // La l√≥gica de WhatsApp no cambia...
        function setupWhatsAppIntegration(formId, apiEndpoint, messageBuilder, options = {}) {
            const form = document.getElementById(formId);
            if (!form) return;
            const submitButton = form.querySelector('button[type="submit"]');
            const statusMessage = form.querySelector(`#${formId}-status-message`);
            const whatsappLinkContainer = form.querySelector(`#${formId}-whatsapp-container`);
            const whatsappLink = form.querySelector(`#${formId}-whatsapp-link`);
            if (!submitButton || !statusMessage || !whatsappLinkContainer || !whatsappLink) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = 'Guardando...';
                statusMessage.textContent = '';
                whatsappLinkContainer.style.display = 'none';
                const formData = new FormData(form);
                const dataObject = Object.fromEntries(formData.entries());
                dataObject.mac = dataObject.mac || 'N/A';
                dataObject.router = dataObject.router || 'N/A';
                try {
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataObject)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Error desconocido' }));
                        throw new Error(errorData.message || 'Error del servidor al guardar');
                    }
                    statusMessage.className = 'status-message success';
                    statusMessage.textContent = '¬°Informaci√≥n guardada con √©xito!';
                    submitButton.style.display = 'none';
                    const whatsappMessage = messageBuilder(dataObject);
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappMessage)}`;
                    whatsappLink.href = whatsappUrl;
                    whatsappLinkContainer.style.display = 'block';
                    if (options.resetFormOnSuccess) {
                        form.reset(); 
                        if (options.postResetCallback) options.postResetCallback();
                    }
                } catch (error) {
                    statusMessage.className = 'status-message error';
                    statusMessage.textContent = `Error: ${error.message}`;
                } finally {
                    if (statusMessage.className.includes('error')) {
                         submitButton.disabled = false;
                         submitButton.textContent = options.originalSubmitText || 'Guardar';
                         submitButton.style.display = 'block';
                    }
                }
            });
        }
        const buildReporteMessage = (data) => {
            return `*Reporte De instalaci√≥n:*\n\n` +
                `*Fecha:* ${data.fecha_reporte || 'N/A'}\n*Hora:* ${data.hora_reporte || 'N/A'}\n*Equipo:* ${data.equipo || 'N/A'}\n` +
                `*ID Solicitud:* ${data.id_solicitud || 'N/A'}\n*Cliente:* ${data.nombre_cliente || 'N/A'}\n*PW Asignado:* ${data.pw_asignado || 'N/A'}\n` +
                `*MAC:* ${data.mac}\n*Router:* ${data.router}\n*Precinto:* ${data.precinto || 'N/A'}\n*ONU PON:* ${data.onu_pon || 'N/A'}\n` +
                `*Instalaci√≥n:* ${data.estado_instalacion || 'N/A'}\n*M√©todo de Pago:* ${data.metodo_pago || 'N/A'}\n*PLAN:* ${data.plan_contratado || 'N/A'}\n` +
                `*V. descarga:* ${data.velocidad_descarga_mbps || 'N/A'}\n*V. Subida:* ${data.velocidad_subida_mbps || 'N/A'}\n*Potencia NAP:* ${data.potencia_nap || 'N/A'}\n` +
                `*Potencia Cliente:* ${data.potencia_cliente || 'N/A'}\n*Metraje utilizado:* ${data.metraje_utilizado_m || 'N/A'}\n` +
                `*Metraje desechado:* ${data.metraje_desechado_m || 'N/A'}\n*Tensores utilizados:* ${data.tensores_utilizados || 'N/A'}\n` +
                `*T√©cnico 1:* ${data.tecnico_1 || 'N/A'}\n*T√©cnico 2:* ${data.tecnico_2 || 'N/A'}`;
        };

        // --- L√ìGICA DEL FORMULARIO Y B√öSQUEDA (ACTUALIZADA) ---
        document.addEventListener('DOMContentLoaded', () => {
            const passwordForm = document.getElementById('password-form');
            const passwordContainer = document.getElementById('password-container');
            const formContainer = document.getElementById('form-container');
            const idSolicitudInput = document.getElementById('id_solicitud');
            const nombreClienteInput = document.getElementById('nombre_cliente');
            
            const modal = document.getElementById('search-modal');
            const openModalBtn = document.getElementById('open-search-modal');
            const closeModalBtn = document.querySelector('.close-button');
            const searchInput = document.getElementById('modal-search-input');
            const resultsList = document.getElementById('search-results-list');
            
            const fastEntryModal = document.getElementById('fast-entry-modal');
            const openFastEntryBtn = document.getElementById('open-fast-entry-modal');
            const closeFastEntryBtn = document.getElementById('close-fast-entry-modal');
            const fastEntryPasswordInput = document.getElementById('fast-entry-password');
            const validateFastEntryBtn = document.getElementById('validate-fast-entry-key');
            const fastEntryMessageDiv = document.getElementById('fast-entry-message');

            let solicitudesPendientes = [];

            // --- FUNCIONES ---
            function fillFormFields(solicitud) {
                if (!solicitud) return;
                idSolicitudInput.value = solicitud.id;
                nombreClienteInput.value = solicitud.nombre_cliente || '';
                nombreClienteInput.readOnly = true; // BLOQUEAR campo cliente
                document.getElementById('plan_contratado').value = solicitud.plan_contratado || '';
                document.getElementById('equipo').value = solicitud.equipo || '';
                document.getElementById('tecnico_1').value = solicitud.tecnico_1 || '';
                document.getElementById('tecnico_2').value = solicitud.tecnico_2 || '';
            }
            
            function renderSearchResults(list) {
                resultsList.innerHTML = '';
                if (list.length === 0) {
                    resultsList.innerHTML = '<div class="search-result-item">No se encontraron resultados.</div>';
                    return;
                }
                list.forEach(solicitud => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = `ID: ${solicitud.id} - ${solicitud.nombre_cliente} (${solicitud.sector})`;
                    item.dataset.id = solicitud.id;
                    resultsList.appendChild(item);
                });
            }

            async function cargarSolicitudes() {
                try {
                    const response = await fetch('/api/solicitudes/pendientes');
                    if (!response.ok) throw new Error('No se pudo conectar.');
                    solicitudesPendientes = await response.json();
                    renderSearchResults(solicitudesPendientes);
                } catch (error) {
                    resultsList.innerHTML = `<div class="search-result-item">Error al cargar: ${error.message}</div>`;
                }
            }

            // --- EVENT LISTENERS ---
            openModalBtn.addEventListener('click', () => modal.style.display = 'block');
            closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
            openFastEntryBtn.addEventListener('click', () => {
                fastEntryModal.style.display = 'block';
                fastEntryPasswordInput.focus();
            });
            closeFastEntryBtn.addEventListener('click', () => fastEntryModal.style.display = 'none');

            window.addEventListener('click', (e) => {
                if (e.target == modal || e.target == fastEntryModal) {
                    modal.style.display = 'none';
                    fastEntryModal.style.display = 'none';
                }
            });

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredList = solicitudesPendientes.filter(s => s.id.toString().includes(searchTerm) || s.nombre_cliente.toLowerCase().includes(searchTerm) || s.sector.toLowerCase().includes(searchTerm));
                renderSearchResults(filteredList);
            });
            
            resultsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('search-result-item') && e.target.dataset.id) {
                    const selectedId = parseInt(e.target.dataset.id);
                    const solicitudSeleccionada = solicitudesPendientes.find(s => s.id === selectedId);
                    fillFormFields(solicitudSeleccionada);
                    modal.style.display = 'none';
                }
            });

            idSolicitudInput.addEventListener('blur', () => {
                const manualId = parseInt(idSolicitudInput.value);
                if (manualId) {
                    const solicitudEncontrada = solicitudesPendientes.find(s => s.id === manualId);
                    if(solicitudEncontrada) fillFormFields(solicitudEncontrada);
                }
            });

            validateFastEntryBtn.addEventListener('click', async () => {
                const enteredKey = fastEntryPasswordInput.value;
                if (enteredKey.length !== 4) {
                    fastEntryMessageDiv.className = 'status-message error';
                    fastEntryMessageDiv.textContent = 'La clave debe tener 4 d√≠gitos.';
                    return;
                }
                fastEntryMessageDiv.textContent = 'Validando...';
                fastEntryMessageDiv.className = 'status-message';
                try {
                    const response = await fetch('/api/validate-temporary-key', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enteredKey })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Clave incorrecta');
                    
                    fastEntryMessageDiv.className = 'status-message success';
                    fastEntryMessageDiv.textContent = '¬°Clave correcta!';
                    
                    document.getElementById('reporteForm').reset();
                    idSolicitudInput.value = 'FP-AUTO';
                    nombreClienteInput.value = '';
                    nombreClienteInput.readOnly = false; // <<< PERMITIR EDICI√ìN
                    nombreClienteInput.focus();
                    
                    setTimeout(() => { fastEntryModal.style.display = 'none'; }, 1000);
                } catch (error) {
                    fastEntryMessageDiv.className = 'status-message error';
                    fastEntryMessageDiv.textContent = error.message;
                }
            });

            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (e.target.querySelector('input').value === '0000') {
                    passwordContainer.style.display = 'none';
                    formContainer.style.display = 'block';
                    const ahora = new Date();
                    const offset = ahora.getTimezoneOffset() * 60000;
                    const ahoraLocal = new Date(ahora.getTime() - offset);
                    document.getElementById('fecha_reporte').value = ahoraLocal.toISOString().split('T')[0];
                    document.getElementById('hora_reporte').value = ahoraLocal.toTimeString().split(' ')[0].substring(0, 5);
                    cargarSolicitudes();
                    setupWhatsAppIntegration('reporteForm', '/api/reportes/instalacion', buildReporteMessage, {
                        resetFormOnSuccess: true,
                        postResetCallback: () => {
                            cargarSolicitudes();
                            const ahora = new Date();
                            const offset = ahora.getTimezoneOffset() * 60000;
                            const ahoraLocal = new Date(ahora.getTime() - offset);
                            document.getElementById('fecha_reporte').value = ahoraLocal.toISOString().split('T')[0];
                            document.getElementById('hora_reporte').value = ahoraLocal.toTimeString().split(' ')[0].substring(0, 5);
                        },
                        originalSubmitText: 'Guardar Reporte'
                    });
                } else {
                    alert('Clave incorrecta.');
                }
            });
            document.getElementById('precinto').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        });
    </script>
</body>
</html>
