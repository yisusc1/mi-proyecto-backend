<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Planificación</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.css">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>

<div id="password-container" class="login-container">
    <div class="login-box">
        <h1>Panel de Planificación</h1>
        <form id="password-form">
            <input type="password" id="password" placeholder="Clave de acceso" required>
            <button type="submit">Ingresar</button>
        </form>
    </div>
</div>

<div id="admin-panel" class="app-container" style="display:none;">
    <header class="app-header">
        <h1>Panel de Planificación</h1>
        <div class="header-controls">
            <div class="temp-key-box">
                <span style="font-size: 0.8rem;">Clave Rápida:</span>
                <code id="temp-key-display">----</code>
                <button id="refresh-key-btn" title="Refrescar Clave">↻</button>
            </div>
            <input type="date" id="fecha-planificacion">
            <button id="add-equipo-btn">➕ Añadir Equipo</button>
        </div>
    </header>
    <main class="kanban-wrapper" id="kanban-board-container"></main>
</div>

<script src="https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const passwordForm = document.getElementById('password-form');
        const dateSelector = document.getElementById('fecha-planificacion');
        const boardContainer = document.getElementById('kanban-board-container');
        
        let kanban;
        let masterTechnicians = [];

        // --- FUNCIONES ---

        async function fetchAndDisplayTempKey() {
            // ... (código sin cambios)
        }

        function updateDisabledOptions() {
            // ... (código sin cambios)
        }
        
        // <<< FUNCIÓN MODIFICADA >>>
        function createTeamControls(equipo = '', tec1 = '', tec2 = '') {
            const letraOptions = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(l => `<option value="Equipo ${l}">Equipo ${l}</option>`).join('');
            const tecOptions = masterTechnicians.map(t => `<option value="${t}">${t}</option>`).join('');
            
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'board-controls';
            controlsDiv.innerHTML = `
                <select class="equipo-select" ${equipo ? 'disabled' : ''}><option value="">Letra Equipo</option>${letraOptions}</select>
                <select class="tecnico-select tecnico1"><option value="">Técnico 1</option>${tecOptions}</select>
                <select class="tecnico-select tecnico2"><option value="">Técnico 2</option>${tecOptions}</select>`;
            
            if (equipo) controlsDiv.querySelector('.equipo-select').value = equipo;
            if (tec1) controlsDiv.querySelector('.tecnico1').value = tec1;
            if (tec2) controlsDiv.querySelector('.tecnico2').value = tec2;
            
            return controlsDiv.outerHTML;
        }

        // <<< NUEVA FUNCIÓN >>>
        function getNextTeamLetter() {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const usedTeams = new Set();
            document.querySelectorAll('.kanban-board').forEach(board => {
                const teamName = board.dataset.id;
                if (teamName && teamName.startsWith('Equipo ')) {
                    usedTeams.add(teamName);
                }
            });

            for (const letter of alphabet) {
                const potentialTeamName = `Equipo ${letter}`;
                if (!usedTeams.has(potentialTeamName)) {
                    return letter;
                }
            }
            return null; // No hay más letras disponibles
        }
        
        const dropEl = function (el, target, source) {
            // ... (código sin cambios)
        };

        function initializeKanban(pending, planned) {
            // ... (código sin cambios)
        }
        
        function loadBoardForDate(dateString) {
            // ... (código sin cambios)
        }

        // --- EVENT LISTENERS ---
        passwordForm.addEventListener('submit', e => {
            // ... (código sin cambios)
        });

        dateSelector.addEventListener('change', () => loadBoardForDate(dateSelector.value));

        // <<< LISTENER MODIFICADO >>>
        document.getElementById('add-equipo-btn').addEventListener('click', () => {
            if (kanban) {
                const nextLetter = getNextTeamLetter();
                if (!nextLetter) {
                    alert('No hay más letras de equipo disponibles.');
                    return;
                }
                const teamName = `Equipo ${nextLetter}`;
                kanban.addBoards([{ id: teamName, title: createTeamControls(teamName), item: [] }]);
                updateDisabledOptions();
            }
        });

        document.getElementById('refresh-key-btn').addEventListener('click', fetchAndDisplayTempKey);
        boardContainer.addEventListener('change', e => {
            if (e.target.matches('.board-controls select')) {
                updateDisabledOptions();
            }
        });
    });

    // Pegar aquí las implementaciones completas de las funciones que marqué como "(código sin cambios)"
    // para asegurar que todo el script esté presente.
    // Por ejemplo:
    async function fetchAndDisplayTempKey() {
        const keyDisplay = document.getElementById('temp-key-display');
        keyDisplay.textContent = '...';
        try {
            const response = await fetch('/api/temporary-key');
            const data = await response.json();
            keyDisplay.textContent = data.key;
        } catch (error) { keyDisplay.textContent = 'Error'; }
    }
    // ... y así con las demás funciones que no se modificaron.
</script>

<style>
    #kanban-board-container > .kanban-container {
        display: flex;
        gap: 1.5rem;
    }
</style>

</body>
</html>
