<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Planificaci√≥n</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>

<div id="password-container" class="login-container">
    <div class="login-box">
        <h1>Panel de Planificaci√≥n</h1>
        <form id="password-form">
            <input type="password" id="password" placeholder="Clave de acceso" required>
            <button type="submit">Ingresar</button>
        </form>
    </div>
</div>

<div id="admin-panel" class="app-container" style="display:none;">
    <header class="app-header">
        <h1>Panel de Planificaci√≥n</h1>
        <div class="header-controls">
            <div class="temp-key-box">
                <span style="font-size: 0.8rem;">Clave R√°pida:</span>
                <code id="temp-key-display">----</code>
                <button id="refresh-key-btn" title="Refrescar Clave">‚Üª</button>
            </div>
            <input type="date" id="fecha-planificacion">
            <button id="add-equipo-btn">‚ûï A√±adir Equipo</button>
        </div>
    </header>
    <main class="planning-area">
        <section class="pending-container">
            <h2>Solicitudes Pendientes</h2>
            <div class="pending-cards-wrapper" id="pending-cards-container"></div>
        </section>
        <section class="teams-grid-wrapper">
            <div class="teams-container" id="teams-container"></div>
        </section>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const passwordForm = document.getElementById('password-form');
    const dateSelector = document.getElementById('fecha-planificacion');
    const mainPlanningArea = document.querySelector('.planning-area');
    const addEquipoBtn = document.getElementById('add-equipo-btn');
    const refreshKeyBtn = document.getElementById('refresh-key-btn');
    
    let masterTechnicians = [], masterSolicitudes = [], masterEquipos = [];
    let draggedCard = null;
    let sourceContainer = null;

    // Funci√≥n para crear el HTML de una tarjeta
    function createCardHTML(solicitud) {
        const telefonos = [solicitud.contacto_1, solicitud.contacto_2].filter(Boolean).join(' / ');
        const ubicacion = [solicitud.ubicacion, solicitud.municipio, solicitud.sector, solicitud.calle, solicitud.casa].filter(Boolean).join(', ');
        
        let statusClass = 'status-pending';
        if (solicitud.estado_solicitud === 'Planificada') statusClass = 'status-planificada';
        else if (solicitud.estado_solicitud === 'Instalado') statusClass = 'status-instalado';
        
        return `
            <div class="card-content">
                <div class="card-title">${solicitud.nombre_cliente || 'Sin Nombre'}</div>
                <div class="card-detail"><strong>Tel√©fono:</strong> <span>${telefonos || 'N/A'}</span></div>
                <div class="card-detail"><strong>Ubicaci√≥n:</strong> <span>${ubicacion || 'No especificada'}</span></div>
                <div class="card-detail"><strong>Servicio:</strong> <span>${solicitud.tipo_servicio || 'No especificado'}</span></div>
                <div class="card-detail"><strong>Asesor:</strong> <span>${solicitud.asesor || 'N/A'}</span></div>
                <div class="card-status-container">
                    <span class="card-status ${statusClass}">${solicitud.estado_solicitud || 'Sin Estado'}</span>
                </div>
            </div>
        `;
    }

    // Funci√≥n para crear elemento de tarjeta
    function createCardElement(solicitud) {
        const card = document.createElement('div');
        card.className = 'solicitud-card';
        card.draggable = true;
        card.dataset.id = solicitud.id;
        card.innerHTML = createCardHTML(solicitud);
        return card;
    }

    // Funci√≥n para crear elemento de equipo
    function createTeamElement(equipo) {
        const teamBoard = document.createElement('div');
        teamBoard.className = 'team-board';
        teamBoard.dataset.equipoId = equipo.id;
        teamBoard.dataset.teamName = equipo.nombre_equipo;
        
        const tecOptions = masterTechnicians.map(t => 
            `<option value="${t.nombre}">${t.nombre}</option>`
        ).join('');
        
        teamBoard.innerHTML = `
            <div class="board-title-container">
                <h3>${equipo.nombre_equipo}</h3>
                <button class="delete-board-btn" title="Eliminar equipo">üóëÔ∏è</button>
            </div>
            <div class="board-controls">
                <select class="tecnico-select tecnico1">
                    <option value="">T√©cnico 1</option>
                    ${tecOptions}
                </select>
                <select class="tecnico-select tecnico2">
                    <option value="">T√©cnico 2</option>
                    ${tecOptions}
                </select>
            </div>
            <div class="card-drop-zone"></div>
        `;
        
        // Establecer valores de t√©cnicos si existen
        if (equipo.tecnico_1) {
            teamBoard.querySelector('.tecnico1').value = equipo.tecnico_1;
        }
        if (equipo.tecnico_2) {
            teamBoard.querySelector('.tecnico2').value = equipo.tecnico_2;
        }
        
        // Agregar tareas asignadas a este equipo
        const dropZone = teamBoard.querySelector('.card-drop-zone');
        const plannedTasks = masterSolicitudes.filter(s => 
            s.equipo === equipo.nombre_equipo && s.estado_solicitud === 'Planificada'
        );
        
        plannedTasks.forEach(task => {
            dropZone.appendChild(createCardElement(task));
        });
        
        return teamBoard;
    }

    // Funci√≥n para renderizar el panel completo
    function renderPanel(solicitudes, equipos) {
        const pendingContainer = document.getElementById('pending-cards-container');
        const teamsContainer = document.getElementById('teams-container');
        
        pendingContainer.innerHTML = '';
        teamsContainer.innerHTML = '';
        
        // Filtrar solicitudes pendientes
        const pending = solicitudes.filter(s => s.estado_solicitud === 'Pendiente');
        pending.forEach(s => pendingContainer.appendChild(createCardElement(s)));
        
        // Crear equipos
        equipos.forEach(equipo => {
            teamsContainer.appendChild(createTeamElement(equipo));
        });
        
        // Agregar listeners
        addDragAndDropListeners();
        updateDisabledOptions();
    }
    
    // Funci√≥n para cargar el panel para una fecha espec√≠fica
    async function loadBoardForDate(dateString) {
        try {
            mainPlanningArea.innerHTML = '<p class="loading-message">Cargando datos...</p>';
            
            const response = await fetch(`/api/planificacion/${dateString}`);
            if (!response.ok) throw new Error('Error al cargar los datos');
            
            const data = await response.json();
            
            mainPlanningArea.innerHTML = `
                <section class="pending-container">
                    <h2>Solicitudes Pendientes</h2>
                    <div class="pending-cards-wrapper" id="pending-cards-container"></div>
                </section>
                <section class="teams-grid-wrapper">
                    <div class="teams-container" id="teams-container"></div>
                </section>
            `;
            
            masterTechnicians = Array.isArray(data.technicians) ? data.technicians : [];
            masterSolicitudes = Array.isArray(data.solicitudes) ? data.solicitudes : [];
            masterEquipos = Array.isArray(data.equipos) ? data.equipos : [];
            
            renderPanel(masterSolicitudes, masterEquipos);
            
        } catch (err) {
            console.error('Error al cargar el panel:', err);
            mainPlanningArea.innerHTML = `
                <p class="error-message">Error al cargar datos: ${err.message}</p>
            `;
        }
    }

    // Funci√≥n para actualizar opciones deshabilitadas en selects
    function updateDisabledOptions() {
        const assignedTechs = new Map();
        
        // Primera pasada: recolectar todas las asignaciones
        document.querySelectorAll('.tecnico-select').forEach(select => {
            if (select.value) {
                assignedTechs.set(select.value, select);
            }
        });
        
        // Segunda pasada: actualizar opciones
        document.querySelectorAll('.tecnico-select').forEach(select => {
            Array.from(select.options).forEach(option => {
                if (option.value) {
                    const assignedSelect = assignedTechs.get(option.value);
                    option.disabled = assignedSelect && assignedSelect !== select;
                    option.hidden = option.disabled;
                }
            });
        });
    }

    // Funci√≥n para agregar listeners de drag and drop
    function addDragAndDropListeners() {
        // Limpiar listeners anteriores
        document.querySelectorAll('.solicitud-card').forEach(card => {
            card.removeEventListener('dragstart', handleDragStart);
            card.removeEventListener('dragend', handleDragEnd);
        });
        
        document.querySelectorAll('.card-drop-zone, .pending-cards-wrapper').forEach(zone => {
            zone.removeEventListener('dragover', handleDragOver);
            zone.removeEventListener('dragleave', handleDragLeave);
            zone.removeEventListener('drop', handleDrop);
        });
        
        // Agregar nuevos listeners
        document.querySelectorAll('.solicitud-card').forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
        });
        
        document.querySelectorAll('.card-drop-zone, .pending-cards-wrapper').forEach(zone => {
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('dragleave', handleDragLeave);
            zone.addEventListener('drop', handleDrop);
        });
    }
    
    // Handlers para drag and drop
    function handleDragStart(e) {
        draggedCard = this;
        sourceContainer = this.closest('.card-drop-zone, .pending-cards-wrapper');
        
        e.dataTransfer.setData('text/plain', this.dataset.id);
        setTimeout(() => this.classList.add('dragging'), 0);
        
        // Feedback visual
        document.querySelectorAll('.card-drop-zone, .pending-cards-wrapper').forEach(zone => {
            zone.classList.add('drag-active');
        });
    }
    
    function handleDragEnd() {
        document.querySelectorAll('.card-drop-zone, .pending-cards-wrapper').forEach(zone => {
            zone.classList.remove('drag-active', 'drag-over');
        });
        
        if (draggedCard) {
            draggedCard.classList.remove('dragging');
            draggedCard.style.opacity = '1';
            draggedCard = null;
        }
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        this.classList.add('drag-over');
        
        // Scroll autom√°tico si estamos cerca de los bordes
        const rect = this.getBoundingClientRect();
        const scrollThreshold = 50;
        
        if (e.clientY < rect.top + scrollThreshold) {
            this.scrollTop -= 10;
        } else if (e.clientY > rect.bottom - scrollThreshold) {
            this.scrollTop += 10;
        }
    }
    
    function handleDragLeave() {
        this.classList.remove('drag-over');
    }
    
    async function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        if (!draggedCard) return;
        
        const solicitudId = e.dataTransfer.getData('text/plain');
        const isUnassign = this.classList.contains('pending-cards-wrapper');
        const targetTeamBoard = this.closest('.team-board');
        
        try {
            // Mostrar feedback de carga
            draggedCard.style.opacity = '0.5';
            draggedCard.style.pointerEvents = 'none';
            
            const body = {
                id: solicitudId,
                equipo: isUnassign ? null : targetTeamBoard.dataset.teamName,
                tecnico1: isUnassign ? null : targetTeamBoard.querySelector('.tecnico1').value,
                tecnico2: isUnassign ? null : targetTeamBoard.querySelector('.tecnico2').value,
                fecha_asignada: dateSelector.value
            };
            
            const endpoint = isUnassign ? '/api/planificacion/unassign' : '/api/planificacion/assign';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) throw new Error(await response.text());
            
            // Actualizar UI despu√©s de √©xito
            loadBoardForDate(dateSelector.value);
            
        } catch (error) {
            console.error('Error en drop:', error);
            alert(`Error: ${error.message}`);
            
            if (sourceContainer) {
                sourceContainer.appendChild(draggedCard);
            }
        } finally {
            if (draggedCard) {
                draggedCard.style.opacity = '1';
                draggedCard.style.pointerEvents = '';
            }
        }
    }

    // Funci√≥n para obtener y mostrar la clave temporal
    async function fetchAndDisplayTempKey() {
        const keyDisplay = document.getElementById('temp-key-display');
        keyDisplay.textContent = '...';
        
        try {
            const response = await fetch('/api/temporary-key');
            if (!response.ok) throw new Error('Error al obtener la clave');
            
            const data = await response.json();
            keyDisplay.textContent = data.key;
        } catch (error) {
            console.error('Error al obtener clave temporal:', error);
            keyDisplay.textContent = 'Error';
        }
    }

    // Evento de env√≠o del formulario de contrase√±a
    passwordForm.addEventListener('submit', async e => {
        e.preventDefault();
        const passwordInput = e.target.querySelector('input');
        
        try {
            // Aqu√≠ deber√≠as hacer una llamada real al servidor para validar la contrase√±a
            // Esto es solo un ejemplo inseguro (deber√≠as cambiarlo)
            if (passwordInput.value === '666') {
                document.getElementById('password-container').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'flex';
                
                // Establecer fecha actual y cargar datos
                dateSelector.valueAsDate = new Date();
                await loadBoardForDate(dateSelector.value);
                await fetchAndDisplayTempKey();
            } else {
                throw new Error('Clave incorrecta');
            }
        } catch (error) {
            alert(error.message);
            passwordInput.value = '';
            passwordInput.focus();
        }
    });
    
    // Evento de cambio de fecha
    dateSelector.addEventListener('change', () => {
        if (dateSelector.value) {
            loadBoardForDate(dateSelector.value);
        }
    });
    
    // Evento para a√±adir nuevo equipo
    addEquipoBtn.addEventListener('click', async () => {
        const teamsContainer = document.getElementById('teams-container');
        const teamLetter = String.fromCharCode(65 + teamsContainer.children.length);
        const teamName = `Equipo ${teamLetter}`;
        
        try {
            const response = await fetch('/api/equipos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    nombre_equipo: teamName, 
                    fecha: dateSelector.value 
                })
            });
            
            if (!response.ok) throw new Error('Error al crear el equipo');
            
            const nuevoEquipo = await response.json();
            loadBoardForDate(dateSelector.value); // Recargar todo para mantener consistencia
            
        } catch (error) {
            console.error('Error al a√±adir equipo:', error);
            alert(`Error: ${error.message}`);
        }
    });

    // Evento para eliminar equipos
    document.getElementById('teams-container').addEventListener('click', async e => {
        if (e.target.classList.contains('delete-board-btn')) {
            const teamBoard = e.target.closest('.team-board');
            const equipoId = teamBoard.dataset.equipoId;
            const teamName = teamBoard.dataset.teamName;
            
            try {
                // Verificar si hay tareas asignadas
                const tasks = teamBoard.querySelectorAll('.solicitud-card');
                
                if (tasks.length > 0) {
                    const confirmar = confirm(
                        `El equipo "${teamName}" tiene ${tasks.length} tarea(s) asignada(s). ` +
                        `¬øDesea eliminarlo y devolver las tareas a pendientes?`
                    );
                    
                    if (!confirmar) return;
                    
                    // Devolver todas las tareas a pendientes
                    await Promise.all(Array.from(tasks).map(async task => {
                        const response = await fetch('/api/planificacion/unassign', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ solicitud_id: task.dataset.id })
                        });
                        
                        if (!response.ok) throw new Error('Error al desasignar tarea');
                    }));
                } else {
                    const confirmar = confirm(`¬øEst√° seguro que desea eliminar el equipo "${teamName}"?`);
                    if (!confirmar) return;
                }
                
                // Eliminar el equipo
                const response = await fetch(`/api/equipos/${equipoId}`, { 
                    method: 'DELETE' 
                });
                
                if (!response.ok) throw new Error('Error al eliminar equipo');
                
                // Recargar el panel
                loadBoardForDate(dateSelector.value);
                
            } catch (error) {
                console.error('Error al eliminar equipo:', error);
                alert(`Error: ${error.message}`);
            }
        }
    });

    // Evento para actualizar t√©cnicos en equipos
    document.getElementById('teams-container').addEventListener('change', async e => {
        if (e.target.matches('.tecnico-select')) {
            const teamBoard = e.target.closest('.team-board');
            const equipoId = teamBoard.dataset.equipoId;
            const tecnico1 = teamBoard.querySelector('.tecnico1').value;
            const tecnico2 = teamBoard.querySelector('.tecnico2').value;
            
            // Validar que no sea el mismo t√©cnico
            if (tecnico1 && tecnico2 && tecnico1 === tecnico2) {
                alert('No se puede asignar el mismo t√©cnico dos veces al mismo equipo.');
                e.target.value = '';
                updateDisabledOptions();
                return;
            }
            
            try {
                const response = await fetch(`/api/equipos/${equipoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        tecnico_1: tecnico1, 
                        tecnico_2: tecnico2 
                    })
                });
                
                if (!response.ok) throw new Error('Error al actualizar t√©cnicos');
                
                // Actualizar opciones deshabilitadas
                updateDisabledOptions();
                
                // Si hay tarjetas asignadas, actualizar tambi√©n sus t√©cnicos
                const cards = teamBoard.querySelectorAll('.solicitud-card');
                if (cards.length > 0) {
                    await Promise.all(Array.from(cards).map(async card => {
                        const solicitudId = card.dataset.id;
                        const response = await fetch('/api/planificacion/assign', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: solicitudId,
                                equipo: teamBoard.dataset.teamName,
                                tecnico1: tecnico1,
                                tecnico2: tecnico2,
                                fecha_asignada: dateSelector.value
                            })
                        });
                        
                        if (!response.ok) throw new Error('Error al actualizar tarea');
                    }));
                    
                    // Recargar para asegurar consistencia
                    loadBoardForDate(dateSelector.value);
                }
                
            } catch (error) {
                console.error('Error al actualizar t√©cnicos:', error);
                alert(`Error: ${error.message}`);
                loadBoardForDate(dateSelector.value); // Recargar para restaurar estado anterior
            }
        }
    });
    
    // Evento para refrescar clave temporal
    refreshKeyBtn.addEventListener('click', fetchAndDisplayTempKey);
});
</script>

</body>
</html>
